Force MD devices to pass SYNC reads directly to the disk
instead of handling from cache.  This is needed for MMP
on MD RAID devices, and in theory could be accepted in
the upstream kernel.  Not needed for DMU.

Index: linux-2.6.32-262.el6.x86_64/drivers/md/raid5.c
===================================================================
--- linux-2.6.32-262.el6.x86_64.orig/drivers/md/raid5.c	2011-05-10 21:38:35.000000000 +0300
+++ linux-2.6.32-262.el6.x86_64/drivers/md/raid5.c	2011-05-20 08:26:04.000000000 +0300
@@ -2214,7 +2214,8 @@ static int add_stripe_bio(struct stripe_
 		}
 		if (sector >= sh->dev[dd_idx].sector + STRIPE_SECTORS)
 			set_bit(R5_OVERWRITE, &sh->dev[dd_idx].flags);
-	}
+ 	} else if (bio_rw_flagged(bi, BIO_RW_SYNCIO))
+ 		clear_bit(R5_UPTODATE, &sh->dev[dd_idx].flags); /* force to read from disk. */
 	spin_unlock_irq(&conf->device_lock);
 
 	pr_debug("added bi b#%llu to stripe s#%llu, disk %d.\n",
@@ -3914,6 +3915,9 @@ static int make_request(struct mddev *md
 		bio_endio(bi, 0);
 	}
 
+	if (bio_rw_flagged(bi, BIO_RW_SYNCIO))
+		md_raid5_unplug_device(conf);
+
 	return 0;
 }
 
